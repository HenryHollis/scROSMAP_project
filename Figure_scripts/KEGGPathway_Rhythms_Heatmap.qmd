---
title: "Heatmap_pathway_rhythms"
format: html
editor: visual
---

Read in TMM and cyclops prediction:

```{r}
library(tidyverse)
#path to cyclops ordering
cyclops_fit= "../Cyclops_ordering/Fits/Fit_Output_2024-02-05T14_13_00.csv"

#I want to arrange the heatmaps by acrophase so I need this
CTL_cycling_file = "../Cyclops_ordering/downstream_output_Mglia_4_5_6_7_8_10_11_13_15_16/cosinor_results_CTL.csv"

#path to normalized counts
path_to_tmm_file = "../normed_counts/Microglia_4_5_6_7_8_10_11_13_15_16_FiltByExprDefault_TMM_CombatAdjusted.csv"

condition = "cond_1"
if(condition == "cond_0"){
  plot_title = "CTL"
}else{
  plot_title = "AD"
}

cyc_pred = read_csv(cyclops_fit, show_col_types = F) %>% arrange(Phase)
tmm = read_csv(path_to_tmm_file, show_col_types = F)
CTL_cycling_res = read_csv(CTL_cycling_file, show_col_types = F)

```

Get Kegg Ribosome pathway:

```{r}
setwd("../Analysis_scripts/MsigDB_gmts_for_GSEA/")
Kegg = read.delim("c2.cp.kegg.v2023.1.Hs.symbols.gmt", sep = '\t', header= F)
ribo = Kegg[grep("RIBOSOME", Kegg$V1), -c(1,2)] %>% unname %>% unlist
```

```{r}
#create breaks of (0, 2pi]
cyc_pred$interval = cut(cyc_pred$Phase,breaks = seq(0, 2*pi, by = pi/2) )

#select genes from tmm in ribo, convert to numeric, transpose to subsXgenes
ribo_tmm = tmm[tmm$Gene_Symbols %in% ribo, ]  %>% column_to_rownames(var = "Gene_Symbols") %>% mutate_if(is.character,as.numeric) %>% t


#merge ribo_tmm with cyclops preds
ribo_tmm = merge(select(cyc_pred, ID, interval, Phase, Covariate_D), ribo_tmm, by.x = "ID", by.y = 0) %>% arrange(Phase) %>% filter(Covariate_D == condition)
print(paste("Using condition:", condition))

#remove Phase and only keep the binned phase called "interval"
ribo_tmm = ribo_tmm %>% column_to_rownames(var = "ID") %>% select(!c(Phase, Covariate_D))
#For each gene, for each time interval, get the median expression for the interval
heatmap_data = ribo_tmm %>% group_by(interval) %>%
  summarise_all(median) %>% column_to_rownames(var = "interval")
heatmap_data = t(heatmap_data)

#arrange rows of heatmap_data to be in order of acrophase
row_order = order(CTL_cycling_res$acrophase[ match(rownames(heatmap_data), CTL_cycling_res$Gene_Symbols)])

heatmap_data = heatmap_data[row_order, ]
```

```{r}
library(gplots)
# times = as.character(seq(0, 24, by = 6))
times = c(expression(pi/2), expression(pi), expression(3*pi/2), expression(2*pi))
heatmap.2(as.matrix(heatmap_data), col = cm.colors, tracecol = "black", trace = "none", dendrogram = "none", scale ="row", Rowv = NA, Colv = NA, labCol = times, main = paste("KEGG Ribosome Pathway", plot_title))
```

NOTES: using Combated data, plotting the MEDIANS of the bins

```{r}
oxphos = Kegg[grep("KEGG_OXIDATIVE_PHOSPHORYLATION", Kegg$V1), -c(1,2)] %>% unname %>% unlist
```

```{r}

#select genes from tmm in ribo, convert to numeric, transpose to subsXgenes
oxphos_tmm = tmm[tmm$Gene_Symbols %in% oxphos, ]  %>% column_to_rownames(var = "Gene_Symbols") %>% mutate_if(is.character,as.numeric) %>% t

#merge oxphos_tmm with cyclops preds
oxphos_tmm = merge(select(cyc_pred, ID, interval, Phase, Covariate_D), oxphos_tmm, by.x = "ID", by.y = 0) %>% arrange(Phase) %>% filter(Covariate_D == condition)
print(paste("Using condition:", condition))

#remove Phase and only keep the binned phase called "interval"
oxphos_tmm = oxphos_tmm %>% column_to_rownames(var = "ID") %>% select(!c(Phase, Covariate_D))
#For each gene, for each time interval, get the median expression for the interval
heatmap_data_oxphos = oxphos_tmm %>% group_by(interval) %>%
  summarise_all(median) %>% column_to_rownames(var = "interval")
heatmap_data_oxphos = t(heatmap_data_oxphos)

#arrange rows of heatmap_data to be in order of acrophase
row_order = order(CTL_cycling_res$acrophase[ match(rownames(heatmap_data_oxphos), CTL_cycling_res$Gene_Symbols)])

heatmap_data_oxphos = heatmap_data_oxphos[row_order, ]
```

```{r}
# times = as.character(seq(0, 24, by = 6))
times = c(expression(pi/2), expression(pi), expression(3*pi/2), expression(2*pi))
heatmap.2(as.matrix(heatmap_data_oxphos), col = cm.colors, tracecol = "black", trace = "none", dendrogram = "none", scale ="row", Rowv = NA, Colv = NA, labCol = times, main = paste("KEGG OxPhos Pathway", plot_title))
```
